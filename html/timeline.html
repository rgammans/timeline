<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title> Example Timeline</title>
    <!-- CSS -->
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.min.css">
      <link rel="stylesheet" type="text/css" href="../css/ui/jquery-ui.min.css" />   
      <link rel="stylesheet" type="text/css" href="../css/ui/datepicker.css" />   
       <!-- JS  from CDNs-->
      <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.js"></script>
      <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>

    <!-- Our JS from bowe -->
      <script type='text/javascript' src="../lib/jquery.js"></script>
      <script type='text/javascript' src="../lib/jquery-ui.min.js"></script>
      <script type='text/javascript' src="../lib/ui/datepicker.js"></script>
    <!-- Our JS (+ Pollyfills )-->
      <script type='text/javascript' src="../lib/rel_moment.js"></script>
      <script type='text/javascript' src="../lib/app.js"></script>
      <script type='text/javascript' src="../lib/simpleFile.js"></script>
      <script type='text/javascript' src="../lib/browser-polyfill.js"></script>
  <style type='text/css'>

legend {
    font-weight: bold;
    font-size: 130%;
}
fieldset {
    margin: 20px 0px 20px 0px;
}
label {
    display: table-row;
}

  </style>
</head>
<body>
<a href="https://github.com/rgammans/timeline"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
<P>
<h2>Example Timeline</h2>
<P>
    <span id="warn">Please note you will need internet access for this to work. Either you don't have it or an error occured</span>
   <p>

    <div id="vis"></div>

    <div id="edit-form">
        <form>
        <div class="absolute_form">
            <fieldset>
                <legend> Edit the selected object </legend>
                <input class="input idfield" name="id" type="hidden">
                <label for="label">Event label:</label>
                <input class="input textfield" name="label" type="text">
                <label for="label">Start Date:</label>
                <input class="input startfield" name="start" type="text">
                <input class="input startfield_alt" name="start_alt" type="hidden">
                <label for="label">End Date (leave blank if an instant):</label>
                <input class="input endfield" name="end" type="text">
                <input class="input endfield_alt" name="end_alt" type="hidden">
                <p>
                <button onclick="app.update_entry()" type="button">Update</button>
            </fieldset>
        </div>
        <div class="relative_form" style="display:none;">
            <fieldset>
            <legend>Create a dependent object</legend>   
                <label for="label">Event label:</label>
                <input class="input textfield" name="label" type="text">
                 This event will be based on "<span class="event_name"></span>" and starts
                   <div class="operations">
                    <div class="operation prototype" style="display:none">
                    <input class="input amt" type="number" name="amt" value="0" min="0">
                    <select class="input units" name="units"></select>
                    <select class="input optype" name="optype"></select>
                    <button class="add_button" type="button" onclick="form_methods.add_operation()">Add another delta</button>
                    <button class="del_button" type="button" onclick="form_methods.remove_operation(this)">Remove this delta</button>
                    </div>
                    <input class="input op_length" type="hidden" value="0">
                    <fieldset class="list"></fieldset>
                   </div>
                of that event.
                <p>
                <button type="button" onclick="form_methods.add_relative_event()" >Create Event</button>
            </fieldset>
        </div>
            <br>
        <div class="instructions">

        </div>
    </div>
            <br>

    <div class="save_load_panel">
    <button onclick="download(app.serialize(),'timeline.jsn','text/json')" type="button">Save Data</button>
    <br>
    <div id="filebox" ></div>
    </div>
</body>
<script>

/** Helper function from http://stackoverflow.com/questions/13405129 */
function download(text, name, type) {
    var a = document.createElement("a");
    var file = new Blob([text], {type: type});
    a.href = URL.createObjectURL(file);
    a.download = name;
    a.click();
}
var x;
$(function() {
    document.x= new SimpleFileReader($('#filebox'),'fileload',{
        display_content:true,
        onload: function(data) { app.unserialize(data); }
    });
    
    //- Unfortunatley this is not compiled so I can't use Es6 syntax here.
    /** update select box from Memory moments ops */
    for (var i in MemoryMoment.ops) {
        var o = MemoryMoment.ops[i];
        var v = MemoryMoment.verbose_ops[i];
        var opt = new Option(v,o);
        $(opt).html=v;
        $('.relative_form .operation.prototype .input.optype').append(opt)
    }
        /** update select box from Memory moments ops */
    for (var i in MemoryMoment.units) {
        var o = MemoryMoment.units[i];
        var opt = new Option(o,o);
        $(opt).html=o;
        $('.relative_form .operation.prototype .input.units').append(opt)
    }    

    //** Define View handlers **/
    $('.absolute_form .startfield').datepicker( {
        altFormat:"yy-mm-dd",
        dateFormat:"dd/mm/yy",
        altField:$('.absolute_form .startfield_alt')
    });
    $('.absolute_form .endfield').datepicker( {
        altFormat:"yy-mm-dd",
        dateFormat:"dd/mm/yy",
        altField:$('.absolute_form .endfield_alt')
    });

    function _update_datepicker(picker, newd) {
        picker.datepicker('setDate',newd);
    }

    form_methods = {
        set_startDate : function (d) {
            _update_datepicker($('.absolute_form .startfield'),d);
        },
        set_endDate : function (d) {
            _update_datepicker($('.absolute_form .endfield'),d);
        },
        set_text : function (d) {
            $('.absolute_form .textfield').prop('value',d);
            $('.relative_form .event_name').html(d);
        },
        set_id : function (d) {
            $('.absolute_form .idfield').prop('value',d);
            this.enable_relative_form ( (typeof(d) != 'undefined') || (typeof(d) == 'null'));
        },
        get_startDate : function (d) {
            return $('.absolute_form .startfield_alt').prop('value');
        },
        get_endDate : function (d) {
            return $('.absolute_form .endfield_alt').prop('value');
        },
        get_text : function (d) {
            return $('.absolute_form .textfield').prop('value');
        },
        get_id : function (d) {
            return $('.absolute_form .idfield').prop('value');
        },
        disable_text : function (d) {
            $('.absolute_form .textfield').prop('diabled',d);
        },
        disable_id : function (d) {
            $('.absolute_form .idfield').prop('disabled',d);
        },
        disable_startDate : function (d) {
            $('.absolute_form .startfield').prop('disabled',d);
        },
        disable_endDate : function (d) {
            return $('.absolute_form .endfield').prop('disabled',d);
        },

        reset_update_form : function () {
            this.set_text("");
            this.set_id(null);
            this.set_startDate(null);
            this.set_endDate(null);
        },
        enable_relative_form: function (yesno) {
            $('.relative_form').toggle(!! yesno);
            if (yesno) {
                //Reset form.
                $('.relative_form .input.op_length').prop('value',0);
                $('.relative_form .input.op_length').prop('value',0);
                $('.relative_form .operations .list').empty();
                this.add_operation();
            }
        },
        add_operation: function () {
             var pane = $('.relative_form .operation.prototype').clone();
             var idx =  $('.relative_form .input.op_length').prop('value');
            //This iindex is just a way of genertating a unique identfier if we add the item
            // we process the entries in DOM order.
             var itemsel = 'item'+idx;
             pane.removeClass('prototype').addClass('item'+idx);
             $('.relative_form .operations .list').append(pane);
             $('.relative_form .operations .'+itemsel).show()
             $('.relative_form .operations .'+itemsel +' .del_button').toggle(!! idx);
             $('.relative_form .input.op_length').prop('value',parseInt(idx)+1);
             $('.relative_form .input.textfield').prop('value',"");
        },
        remove_operation: function (target) {
            $(target).parent().addClass('removed').hide();
        },
        add_relative_event: function () {
            var content = $('.relative_form .input.textfield').prop('value')
            var ops = [];
            $('.relative_form .operations .list .operation').each(function () {
                var obj = {};
                if ( ! $(this).hasClass('removed') ){
                    obj.amt = $('.input.amt',this).prop('value');
                    obj.units = $('.input.units',this).prop('value');
                    obj.op = $('.input.optype',this).prop('value');
                    ops.push(obj);
                }
            });
            app.create_event_relative(content,this.get_id(),'start',ops);
        }
    }

});
</script>
<script type='text/javascript'>
$(function(){
    /**
    *  Initialise the dataset and launch the main app controller 
    */
    var container = document.getElementById('vis');
     app = new TimelineRelations();

//*************************************************************************************************************************
// Make your edits here between these two rows of stars

game_start =            app.create_event("Game Start",                          moment("2015-12-21"));
s_happen =              app.create_event("Something Happend",                   new MemoryMoment(game_start).subtract(2,'months'));
                        app.create_event("Guy Fawkes",                          moment("2015-11-05"));
other =                 app.create_event("Another thing happens",               s_happen.add(1,'day')); 
today              =    app.create_event("England declares WAR!",               moment());

//****************************************************************************************************************************

    app.run(container,form_methods);
    document.getElementById('warn').style.display = "none";
});
</script>


</html>

